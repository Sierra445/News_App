{% extends 'newsapp/base.html' %}

{% block title %}Home - Newsly{% endblock %}

{% block content %}
<div class="hero-section">
  <h1>Latest News</h1>
  <p>Stay updated with the latest articles and stories</p>

  <!-- News Ticker -->
  <div class="news-ticker-hero" aria-hidden="false">
      <div class="ticker-title">Breaking:</div>

      <div class="ticker-viewport">
          <div class="ticker-track">

              {% if latest_articles %}
                  {% for article in latest_articles %}
                      <span class="ticker-item">{{ article.title }}</span>
                  {% endfor %}
              {% else %}
                  {% for article in articles %}
                      <span class="ticker-item">{{ article.title }}</span>
                  {% endfor %}
              {% endif %}

          </div>
      </div>
  </div>
</div>



<div class="weather-widget">
    {% for w in weather_list %}
    <div class="weather-card" data-weather-card>
        <div class="weather-icon-container {{ w.main|lower }}">
            <img src="https://openweathermap.org/img/wn/{{ w.icon }}@2x.png" alt="">
        </div>
        <div class="weather-info">
            <h3>{{ w.city }}</h3>
            <p class="weather-temp">{{ w.temp|floatformat:0 }}°C</p>
            <p class="weather-desc">{{ w.description }}</p>
        </div>
    </div>
    {% endfor %}
</div>

    <div class="masonry-grid">
    {% for article in articles %}
    <article class="masonry-item">
        {% if article.image %}
            <img src="{{ article.image.url }}" alt="{{ article.title }}">
        {% endif %}

        <h2>{{ article.title }}</h2>

        <p class="article-meta">
            By {{ article.author }} — 
            {{ article.created_at|date:"F j, Y" }}
        </p>

        <p class="excerpt">{{ article.content|truncatewords:25 }}</p>

        <a href="{% url 'article_detail' article.id %}" class="read-more">
            Read More
        </a>
    </article>
    {% empty %}
    <div class="no-articles">
        <p>No articles available yet.</p>
    </div>
    {% endfor %}
</div>


<script>
let cards = document.querySelectorAll("[data-weather-card]");
let index = 0;

function rotateWeather() {
    cards.forEach((c, i) => {
        c.style.display = i === index ? "flex" : "none";
    });
    index = (index + 1) % cards.length;
}

rotateWeather();
setInterval(rotateWeather, 5000);

document.addEventListener("DOMContentLoaded", function () {
  const track = document.querySelector('.ticker-track');
  const viewport = document.querySelector('.ticker-viewport');

  if (!track || !viewport) return;

  // If no items, do nothing
  const items = track.querySelectorAll('.ticker-item');
  if (!items.length) return;

  // Duplicate the content so we can have a continuous loop
  track.innerHTML = track.innerHTML + track.innerHTML;

  // Helper to create/update the animation based on measured width
  let animStyleEl = document.getElementById('ticker-anim-style');
  if (!animStyleEl) {
    animStyleEl = document.createElement('style');
    animStyleEl.id = 'ticker-anim-style';
    document.head.appendChild(animStyleEl);
  }

  function updateTickerAnimation() {
    // width of first half (original content)
    const totalWidth =  Array.from(track.children)
                            .slice(0, items.length)
                            .reduce((acc, el) => acc + el.getBoundingClientRect().width + parseFloat(getComputedStyle(track).gap || 0), 0);

    // safety: if totalWidth is 0, bail out
    if (totalWidth <= 0) return;

    // choose a smooth scroll speed: pixels per second (adjustable)
    const pxPerSecond = 80; // lower = slower, increase to speed up
    const duration = Math.max(8, totalWidth / pxPerSecond); // seconds

    // Build keyframes CSS
    const keyframes = `
      @keyframes ticker-scroll {
        0%   { transform: translateX(0); }
        100% { transform: translateX(-${totalWidth}px); }
      }
    `;
    // Insert CSS to the style element
    animStyleEl.innerHTML = keyframes + `
      .ticker-track {
         animation: ticker-scroll ${duration}s linear infinite;
      }
    `;
  }

  // initial setup
  updateTickerAnimation();

  // recompute animation on window resize (debounced)
  let resizeTimeout;
  window.addEventListener('resize', function () {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(updateTickerAnimation, 200);
  });
});
</script>
{% endblock %}

